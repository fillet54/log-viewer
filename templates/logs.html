{% extends "base.html" %}

{% block content %}
  <div class="max-w-screen-2xl mx-auto w-full px-4 py-8">
    <div class="grid md:grid-cols-[18rem,1fr] gap-4">
      <aside class="bg-base-100 shadow rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h1 class="text-lg font-semibold">Datasets</h1>
          <a class="btn btn-xs btn-outline" href="{{ url_for('upload_logs') }}">Upload</a>
        </div>
        <div class="space-y-2">
          {% for dataset in datasets %}
            <a
              class="block rounded-lg border px-3 py-2 text-sm {% if dataset.id == selected_dataset_id %}border-primary bg-primary/10{% else %}border-base-300 hover:border-base-content/30{% endif %}"
              href="{{ url_for('logs_index', dataset_id=dataset.id) }}"
            >
              <div class="font-medium">{{ dataset.name }}</div>
              <div class="text-xs text-base-content/60">
                {% if dataset.owner_user_id %}Personal{% else %}Global{% endif %}
              </div>
            </a>
          {% else %}
            <div class="text-sm text-base-content/70">No datasets available.</div>
          {% endfor %}
        </div>
      </aside>

      <section class="bg-base-100 shadow rounded-xl p-5">
        <h2 class="text-xl font-semibold mb-1">Logs</h2>
        <p class="text-sm text-base-content/70 mb-4">Grouped by event name. Expand to view each boot.</p>
        <div class="grid md:grid-cols-[1fr,1fr,10rem,auto,auto] gap-2 mb-4 items-end">
          <label class="form-control">
            <span class="label-text text-xs">Event Name (Live Fuzzy)</span>
            <input
              id="event-name-search"
              type="text"
              class="input input-bordered input-sm"
              placeholder="Type to fuzzy match event names..."
              autocomplete="off"
            />
          </label>
          <form method="get" class="contents">
          {% if selected_dataset_id %}
            <input type="hidden" name="dataset_id" value="{{ selected_dataset_id }}" />
          {% endif %}
          <label class="form-control">
            <span class="label-text text-xs">System</span>
            <select name="system" class="select select-bordered select-sm">
              <option value="">All systems</option>
              {% for system_name in system_options %}
                <option value="{{ system_name }}" {% if filter_system == system_name %}selected{% endif %}>{{ system_name }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="form-control">
            <span class="label-text text-xs">Mode</span>
            <select name="mode" class="select select-bordered select-sm">
              <option value="" {% if not filter_mode %}selected{% endif %}>All modes</option>
              <option value="production" {% if filter_mode == "production" %}selected{% endif %}>Production</option>
              <option value="test" {% if filter_mode == "test" %}selected{% endif %}>Test</option>
            </select>
          </label>
          <button class="btn btn-sm btn-primary" type="submit">Filter</button>
          <a class="btn btn-sm btn-ghost" href="{{ url_for('logs_index', dataset_id=selected_dataset_id) if selected_dataset_id else url_for('logs_index') }}">Reset</a>
          </form>
        </div>
        <div id="event-name-search-status" class="text-xs text-base-content/60 mb-3"></div>

        {% if grouped_boots %}
          <div id="event-groups" class="space-y-3">
            {% for group in grouped_boots %}
              <details class="collapse collapse-arrow border border-base-300 bg-base-100" data-event-name="{{ group.event_name|lower }}">
                <summary class="collapse-title pr-2">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <div class="font-semibold">{{ group.event_name }}</div>
                      <div class="text-xs text-base-content/60">{{ group.boots|length }} boot(s)</div>
                    </div>
                    {% if group.latest_production_boot %}
                      <a
                        class="btn btn-xs btn-primary"
                        href="{{ url_for('index', dataset=group.latest_production_boot.dataset_id, boot=group.latest_production_boot.boot_id) }}"
                        onclick="event.stopPropagation();"
                      >
                        Latest Production
                      </a>
                    {% endif %}
                  </div>
                </summary>
                <div class="collapse-content pt-0">
                  <div class="overflow-x-auto">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Boot ID</th>
                          <th>Mode</th>
                          <th>System</th>
                          <th>Tags</th>
                          <th>Events</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for boot in group.boots %}
                          {% set meta = boot_meta_map.get(boot.meta_key) %}
                          <tr>
                            <td class="font-mono">{{ boot.boot_id }}</td>
                            <td>
                              {% if meta.mode == "production" %}
                                <span class="badge badge-success badge-outline">production</span>
                              {% else %}
                                <span class="badge badge-warning badge-outline">test</span>
                              {% endif %}
                            </td>
                            <td>{{ meta.system }}</td>
                            <td>{{ meta.tags }}</td>
                            <td>{{ boot.event_count }}</td>
                            <td class="flex gap-2">
                              <a class="btn btn-xs btn-outline" href="{{ url_for('index', dataset=boot.dataset_id, boot=boot.boot_id) }}">Open</a>
                              <a class="btn btn-xs btn-ghost" href="{{ url_for('edit_boot', dataset_id=boot.dataset_id, boot_id=boot.boot_id) }}">Edit</a>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </details>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-base-content/70">No logs found for this dataset.</div>
        {% endif %}
      </section>
    </div>
  </div>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script>
    (function () {
      const input = document.getElementById("event-name-search");
      const status = document.getElementById("event-name-search-status");
      const groups = Array.from(document.querySelectorAll("#event-groups [data-event-name]"));
      if (!input || !groups.length) return;

      const normalize = (value) => (value || "").toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
      const fuzzyScore = (query, target) => {
        if (!query) return 1;
        if (!target) return 0;
        if (target.includes(query)) return query.length + 8;
        let qi = 0;
        let score = 0;
        let streak = 0;
        for (let i = 0; i < target.length && qi < query.length; i++) {
          if (target[i] === query[qi]) {
            qi += 1;
            streak += 1;
            score += 1 + streak;
          } else {
            streak = 0;
          }
        }
        return qi === query.length ? score : 0;
      };

      const applySearch = () => {
        const q = normalize(input.value);
        let visible = 0;
        for (const group of groups) {
          const eventName = normalize(group.dataset.eventName || "");
          const matched = !q || fuzzyScore(q, eventName) > 0;
          group.style.display = matched ? "" : "none";
          if (matched) visible += 1;
        }
        status.textContent = q
          ? `${visible} matching event group(s)`
          : `${groups.length} event group(s)`;
      };

      input.addEventListener("input", applySearch);
      applySearch();
    })();
  </script>
{% endblock %}
